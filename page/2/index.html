<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jnjyan.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":250,"display":"hide","padding":12,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="以梦为马，越骑越傻">
<meta property="og:type" content="website">
<meta property="og:title" content="Black Eye Galaxy">
<meta property="og:url" content="https://jnjyan.github.io/page/2/index.html">
<meta property="og:site_name" content="Black Eye Galaxy">
<meta property="og:description" content="以梦为马，越骑越傻">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="JNJYan">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://jnjyan.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Black Eye Galaxy</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?223443aa6efb3158acac1d42a993f246";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Black Eye Galaxy</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jnjyan.github.io/beeec84afaca/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E9%BB%91%E7%99%BD.jpg">
      <meta itemprop="name" content="JNJYan">
      <meta itemprop="description" content="以梦为马，越骑越傻">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Black Eye Galaxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/beeec84afaca/" class="post-title-link" itemprop="url">Google C++风格指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-24 17:53:57" itemprop="dateCreated datePublished" datetime="2021-03-24T17:53:57+00:00">2021-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 08:59:08" itemprop="dateModified" datetime="2023-06-18T08:59:08+00:00">2023-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          
            <span id="/beeec84afaca/" class="post-meta-item leancloud_visitors" data-flag-title="Google C++风格指南" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/beeec84afaca/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/beeec84afaca/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h2><h3 id="self-contained头文件"><a href="#self-contained头文件" class="headerlink" title="self-contained头文件"></a>self-contained头文件</h3><p>头文件需要自给自足，头文件本身应当是能编译的（个人理解时在没有源文件<code>.cxx</code>的情况也能编译通过）。</p>
<p>头文件应当用<code>#define</code>保护，并包含其所需要的所有其他头文件。</p>
<p>模板和内联函数的定义和声明应当处于同一文件内。</p>
<h3 id="define保护"><a href="#define保护" class="headerlink" title="define保护"></a>define保护</h3><p>所有头文件都应该使用<code>#define</code>防止文件被多重包含，并且为了保证唯一性，宏命名应当基于所在项目源码的全路径，格式应当为<code>&lt;PROJECT&gt;_&lt;PATH&gt;_&lt;FILE&gt;_H_</code>。</p>
<h3 id="引入所有使用的头文件"><a href="#引入所有使用的头文件" class="headerlink" title="引入所有使用的头文件"></a>引入所有使用的头文件</h3><p>不要依赖于<code>include</code>传递，如果<code>foo.cxx</code>文件使用了<code>bar.h</code>中的符号，就应当在<code>foo.cxx</code>中引入<code>bar.h</code>，即使在<code>bar.h</code>已经引入了。</p>
<p>也就是说，尽量在源文件中引入库，而不是在对应的头文件中引入，目的是为了减少引入依赖。例如当<code>A.cxx</code>依赖于<code>B.h</code>时，对<code>B.h</code>的任何修改都会导致<code>A.cxx</code>的重新构建，而此时<code>B.cxx</code>依赖于<code>C.h</code>，那么我们现在有两个选择，一是在<code>B.cxx</code>中引入<code>C.h</code>，二是在<code>B.h</code>中引入<code>C.h</code>。若选择第二种，我们对<code>C.h</code>的任何修改都会导致<code>A.cxx</code>的重新构建，若选择第一种，则不会触发<code>A.cxx</code>的重新构建。</p>
<h3 id="前置声明"><a href="#前置声明" class="headerlink" title="前置声明"></a>前置声明</h3><p>前置声明是指类、函数和模板不带有定义的纯粹声明，应当避免使用前置声明，将声明放在头文件中，然后<code>#include</code>。</p>
<ul>
<li>优点<ul>
<li>前置声明能够节省编译时间。</li>
<li>前置声明能节省不必要的重新编译时间，使用<code>#include</code>会使得代码由于头文件中无关改动而被重新编译。</li>
</ul>
</li>
<li>缺点<ul>
<li>前置声明隐藏依赖关系，头文件改动时，源文件会跳过必要的重新编译过程。</li>
<li>前置声明可能被库的后续更改所破坏。</li>
<li>前置声明来自<code>std::</code>中的符号时，行为未定义。</li>
<li>前置声明甚至会改变代码含义。</li>
<li>重构代码更为复杂和困难。</li>
</ul>
</li>
</ul>
<h3 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h3><ul>
<li>经验：<ul>
<li>只有函数不多于10行时才将其定义为内联函数</li>
<li>不要内联包含循环和<code>switch</code>的函数</li>
<li>不要内联递归函数</li>
<li>即使声明为内联函数，编译器也不一定会接受</li>
<li>类声明内定义的函数默认为内联函数</li>
</ul>
</li>
</ul>
<h3 id="include的路径和顺序"><a href="#include的路径和顺序" class="headerlink" title="include的路径和顺序"></a>include的路径和顺序</h3><p>避免使用<code>.</code>和<code>..</code>，按照项目源码路径完整<code>include</code>。</p>
<ul>
<li>内联顺序：<ol>
<li>同名头文件</li>
<li>C系统文件</li>
<li>C++系统文件</li>
<li>其他库<code>.h</code></li>
<li>本项目<code>.h</code></li>
</ol>
</li>
</ul>
<p>这种优先顺序保证了当<code>.h</code>文件遗漏某些库时，源文件的构建会立刻终止。</p>
<p>不同类型的头文件空格分隔。</p>
<p>例外情况，条件编译绝对是否引入库，如不同平台。</p>
<h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>C++中的全局函数和全局变量的作用域是整个项目，为了限制其作用域，一种做法是使用<code>static</code>关键字修饰，另一种是使用命名空间。</p>
<p>在不需要外部访问的情况下，C++标准提倡使用匿名命名空间，禁止使用<code>using</code>引入命名空间，禁止使用内联命名空间。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> X&#123;</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">namespace</span> Y&#123;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 别名</span></span><br><span class="line"><span class="keyword">namespace</span> baz = ::foo::bar::baz;</span><br></pre></td></tr></table></figure>

<p>在内联命名空间中，<code>X::Y::foo()</code>与<code>X::foo()</code>等价，其目的主要是用来兼容跨版本API。</p>
<p>命名空间使用策略：</p>
<ul>
<li>遵循命名空间命名规范</li>
<li>命名空间结束时，使用注释</li>
<li>命名空间应当在头文件、gflag声明与定义、其他空间的类前置声明之后</li>
<li>禁止在<code>std</code>内声明任何东西，属于未定义行为，导致不可移植</li>
<li>禁止在头文件中使用命名空间别名，除非限制在内部命名空间中使用</li>
<li>禁止使用<code>using</code>引入命名空间</li>
<li>禁止使用内联命名空间</li>
</ul>
<h3 id="匿名命名空间与静态变量"><a href="#匿名命名空间与静态变量" class="headerlink" title="匿名命名空间与静态变量"></a>匿名命名空间与静态变量</h3><p>在<code>cxx</code>中定义不需要被外部引用的符号时，可以放在匿名命名空间或声明为<code>static</code>，但不要在头文件中这样做。</p>
<h3 id="非成员函数、静态成员函数、全局函数"><a href="#非成员函数、静态成员函数、全局函数" class="headerlink" title="非成员函数、静态成员函数、全局函数"></a>非成员函数、静态成员函数、全局函数</h3><p>使用静态成员或命名空间内的非成员函数，不要使用裸的全局函数，不要用类的静态方法模拟命名空间效果，类的静态方法应当与类的实例或静态数据密切相关。</p>
<p>非成员函数置于命名空间避免污染全局作用域。</p>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>将函数变量尽可能放在最小作用域内，在变量声明时进行初始化。</p>
<p>除非变量是一个对象，每次进入作用域都需要调用构造函数，退出作用域调用析构函数。</p>
<h3 id="静态和全局变量"><a href="#静态和全局变量" class="headerlink" title="静态和全局变量"></a>静态和全局变量</h3><p>静态生存周期的对象，包括全局变量、静态变量、静态类成员、函数静态变量，必须是原生数据类型(POD, Plain Old Data)。</p>
<p>在多编译单元中，静态变量的构造、析构和初始化顺序在C++中只有部分是明确的，甚至随着构建发生变化，导致难以发现的bug，禁止使用类的静态存储周期变量。</p>
<p>在同一编译单元中顺序是明确的，静态初始化优于动态初始化、初始化顺序按照声明顺序进行，逆序销毁，不同编译单元内，属于未明确行为。</p>
<p>多线程时，静态生存周期不要使用非POD的对象以及STL容器。</p>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>不要在构造函数中调用虚函数，也不要在无法报错时进行可能失败的初始化。</p>
<p>构造函数内调用自身的虚函数并不会重定向到子类的虚函数实现。</p>
<p>如果执行失败，可能会得到一个初始化失败的对象，这个对象可能无法进入到正常状态。</p>
<p>如果对象需要进行初始化，通过定义<code>Init()</code>方法或工厂方法进行创建并初始化。</p>
<h3 id="隐式类型转换"><a href="#隐式类型转换" class="headerlink" title="隐式类型转换"></a>隐式类型转换</h3><p>一脸懵比</p>
<h3 id="可拷贝类型和可移动类型"><a href="#可拷贝类型和可移动类型" class="headerlink" title="可拷贝类型和可移动类型"></a>可拷贝类型和可移动类型</h3><p>如果不需要，禁用隐式生成的拷贝和移动构造函数。</p>
<h3 id="结构体-x2F-类"><a href="#结构体-x2F-类" class="headerlink" title="结构体&#x2F;类"></a>结构体&#x2F;类</h3><p>仅当只有数据成员和重载运算符时使用<code>struct</code>，其他一概使用<code>class</code>。</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="参数顺序"><a href="#参数顺序" class="headerlink" title="参数顺序"></a>参数顺序</h3><p>输入参数在前，输出参数在后。</p>
<h3 id="简短函数"><a href="#简短函数" class="headerlink" title="简短函数"></a>简短函数</h3><p>优先编写简短函数，若行数超过四十行考虑分离。</p>
<h3 id="引用参数"><a href="#引用参数" class="headerlink" title="引用参数"></a>引用参数</h3><p>引用必须用<code>const</code>，对变量进行修改传指针。除非特殊要求，如<code>swap()</code>。</p>
<h3 id="函数重载"><a href="#函数重载" class="headerlink" title="函数重载"></a>函数重载</h3><p>函数重载尽量能够简单明了，尽量不要改变相同数量的参数类型来进行重载。可以考虑在函数名中加入类型信息。</p>
<h3 id="缺省参数"><a href="#缺省参数" class="headerlink" title="缺省参数"></a>缺省参数</h3><p>只允许在非虚函数中使用缺省参数，尽可能使用函数重载而非缺省参数。</p>
<p>优点：</p>
<ul>
<li>降低代码量，降低代码修改时的工作量，函数重载需要修改多个函数。</li>
</ul>
<p>缺点：</p>
<ul>
<li>虚函数调用的缺省参数取决于目标对象的静态类型，无法保证给定函数的所有重载声明的都是同样的缺省参数。</li>
<li>缺省参数会干扰函数指针，导致函数签名与调用点签名不一致。</li>
<li>缺省参数每次调用都需要重新求值,导致生成的代码膨胀。</li>
</ul>
<h3 id="函数返回类型后置语法"><a href="#函数返回类型后置语法" class="headerlink" title="函数返回类型后置语法"></a>函数返回类型后置语法</h3><p>只有常规写法不便于书写或阅读时才使用返回类型后置语法。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> x)</span> -&gt; <span class="type">int</span></span>;</span><br></pre></td></tr></table></figure>

<p>优点：</p>
<ul>
<li>后置返回类型是显示指定Lambda表达式返回值类型的唯一方式，通常情况下编译器能够自动推导出Lambda表达式的返回类型，但并不是所有情况。</li>
</ul>
<p>缺点：</p>
<ul>
<li>陌生，与原始代码看起来不协调（黑人问号？）</li>
</ul>
<h2 id="G式奇淫技巧"><a href="#G式奇淫技巧" class="headerlink" title="G式奇淫技巧"></a>G式奇淫技巧</h2><h3 id="所有权与智能指针"><a href="#所有权与智能指针" class="headerlink" title="所有权与智能指针"></a>所有权与智能指针</h3><p>C++11后时代C++程序员的常识题，不要使用<code>std::auto_ptr</code>，使用<code>std::unique_ptr</code>或<code>std::shared_ptr</code>，倾向于前者。</p>
<h3 id="Cpplint"><a href="#Cpplint" class="headerlink" title="Cpplint"></a>Cpplint</h3><p>风格检查<a target="_blank" rel="noopener" href="https://github.com/google/styleguide/blob/gh-pages/cpplint/cpplint.py">cpplint.py</a></p>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><h3 id="通用命名规则"><a href="#通用命名规则" class="headerlink" title="通用命名规则"></a>通用命名规则</h3><p>描述性命名，如果你也曾被前人项目中的缩写整懵比那就少用缩写，如果实在需要，请在声明位置加注释。</p>
<h3 id="文件命名"><a href="#文件命名" class="headerlink" title="文件命名"></a>文件命名</h3><p>全部小写，下划线<code>_</code>连接。不要与<code>/usr/include</code>下的文件重名。</p>
<p>内联函数放在<code>.h</code>文件中。</p>
<h3 id="类型命名"><a href="#类型命名" class="headerlink" title="类型命名"></a>类型命名</h3><p>类、结构体、类型定义、枚举、类型模板参数。每个单词首字母大写，不应包含下划线。</p>
<h3 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h3><p>变量与数据成员一律小写，单词之间用下划线连接，类的成员变量用下划线结尾，结构体变量与普通变量一致，无需加下划线。</p>
<h3 id="常量命名"><a href="#常量命名" class="headerlink" title="常量命名"></a>常量命名</h3><p>声明为<code>constexpr</code>和<code>const</code>的变量，或在程序运行i期间其值始终保持不变的以<code>k</code>开头，大小写混合。</p>
<h3 id="函数命名"><a href="#函数命名" class="headerlink" title="函数命名"></a>函数命名</h3><p>常规函数大小写混合，取值或设值要求与变量名匹配，如<code>set_num()</code>，<code>get_num()</code>。</p>
<p>对于函数名中出现的单词缩写倾向于全部用大写<code>StartRPC()</code>。</p>
<h3 id="命名空间命名"><a href="#命名空间命名" class="headerlink" title="命名空间命名"></a>命名空间命名</h3><p>命名空间以小写字母命名，最高级命名空间取决于项目名称或团队名，避免嵌套命名空间与上层命名空间之间存在冲突。</p>
<p>命名空间中的代码，应当存放于与命名空间的名字匹配的文件夹或其子文件夹中。</p>
<p>不要使用缩写。</p>
<h3 id="枚举命名"><a href="#枚举命名" class="headerlink" title="枚举命名"></a>枚举命名</h3><p>枚举命名与常量或宏保持一致<code>kEnumName</code>、<code>ENUM_NAME</code>。优先采用常量命名方式。</p>
<h2 id="宏命名"><a href="#宏命名" class="headerlink" title="宏命名"></a>宏命名</h2><p>参见<a href="">不要用宏</a>，如果不得不适用，全部大写，下划线连接。</p>
<h3 id="注释风格"><a href="#注释风格" class="headerlink" title="注释风格"></a>注释风格</h3><p>项目统一风格<code>//</code>或<code>/* */</code></p>
<p>写好<code>TODO</code>、<code>FIX</code>、<code>DEPRECATED</code></p>
<h3 id="我是不可能写注释的，告辞"><a href="#我是不可能写注释的，告辞" class="headerlink" title="我是不可能写注释的，告辞"></a>我是不可能写注释的，告辞</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jnjyan.github.io/293170dd2093/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E9%BB%91%E7%99%BD.jpg">
      <meta itemprop="name" content="JNJYan">
      <meta itemprop="description" content="以梦为马，越骑越傻">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Black Eye Galaxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/293170dd2093/" class="post-title-link" itemprop="url">__attribute__那些事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-24 17:16:51" itemprop="dateCreated datePublished" datetime="2021-03-24T17:16:51+00:00">2021-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 08:59:08" itemprop="dateModified" datetime="2023-06-18T08:59:08+00:00">2023-06-18</time>
              </span>

          
            <span id="/293170dd2093/" class="post-meta-item leancloud_visitors" data-flag-title="__attribute__那些事" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/293170dd2093/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/293170dd2093/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jnjyan.github.io/0972cc345c7d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E9%BB%91%E7%99%BD.jpg">
      <meta itemprop="name" content="JNJYan">
      <meta itemprop="description" content="以梦为马，越骑越傻">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Black Eye Galaxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/0972cc345c7d/" class="post-title-link" itemprop="url">C++宏定义的那些事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-23 21:57:57" itemprop="dateCreated datePublished" datetime="2021-03-23T21:57:57+00:00">2021-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 08:59:08" itemprop="dateModified" datetime="2023-06-18T08:59:08+00:00">2023-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-%E7%9B%B8%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">C++相关</span></a>
                </span>
            </span>

          
            <span id="/0972cc345c7d/" class="post-meta-item leancloud_visitors" data-flag-title="C++宏定义的那些事" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/0972cc345c7d/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/0972cc345c7d/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a>宏定义</h2><p>宏定义将一个标识符定义为一个字符串，源代码中的标识符将被指定的字符串替换，这个过程发生在预处理阶段。<br>发方<br>C++程序的完整编译过程包括预处理、编译、汇编、链接四个步骤。其中预处理阶段进行宏展开、条件编译等。</p>
<p>在C语言中，通过宏来定义简单函数，可以降低函数调用过程中的开销，而在c++中，可以用<code>inline</code>来声明内联函数来降低函数调用过程的开销。</p>
<p>也可以通过宏来定义一些常量，但由于宏替换发生在预处理阶段，因此如果在编译过程中产生错误，很难进行错误的定位和溯源。</p>
<h2 id="简单的宏定义"><a href="#简单的宏定义" class="headerlink" title="简单的宏定义"></a>简单的宏定义</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PI2 3.1415926</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Add(x) x+1 <span class="comment">//错误示范</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Double(x) (x*2) <span class="comment">//错误示范</span></span></span><br><span class="line"><span class="comment">// Add(x) * 2 ==&gt; x + 1 * 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Add(x) ((x)+1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Double(x) ((x)*2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//第二种</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SOURCE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOURCE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEST</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TEST</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;this is a TEST &quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TEST</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;there are not TEST&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>宏的两种简单用法如上所示，第一种用法将<code>PI</code>全部替换为<code>3.1415926</code>，这里的替换是直接展开的，如错误示范中所示，因此我们在使用宏定义时，要利用括号保证其在展开时不会产生错误。</p>
<p>第二种用法通过宏定义来实现条件编译、避免头文件的重复引入。</p>
<h2 id="宏的高阶用法"><a href="#宏的高阶用法" class="headerlink" title="宏的高阶用法"></a>宏的高阶用法</h2><p><code>#</code>、<code>##</code>、<code>#@</code>三种可以称之为宏的高阶用法，可以实现许多高级特性。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> STRING(msg) #msg</span></span><br><span class="line"><span class="type">char</span>* str = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="type">char</span>* str = <span class="built_in">STRING</span>(hello);  <span class="comment">//二者等价</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHAR(ch) #@ch</span></span><br><span class="line"><span class="type">char</span> ch = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"><span class="type">char</span> ch = <span class="built_in">CHAR</span>(a); <span class="comment">//二者等价</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> </span></span><br></pre></td></tr></table></figure>

<p>当宏中遇到<code>#</code>和<code>##</code>时，是不能够进行嵌套替换的，不会对<code>#</code>和<code>##</code>之后宏进行展开。</p>
<h2 id="可变参数宏"><a href="#可变参数宏" class="headerlink" title="可变参数宏"></a>可变参数宏</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> VARGS_(_10, _9, _8, _7, _6, _5, _4, _3, _2, _1, N, ...) N</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VARGS(...) VARGS_(__VA_ARGS__, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONCAT_(a, b) a ### b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONCAT(a, b) CONCAT_(a, b) <span class="comment">// 由于##会阻止宏的展开，因此两次宏替换解决宏的嵌套问题</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_3(prefix, name, n) func(prefix, name, n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_2(prefix, name) FUNC_3(prefix, name, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC(...) CONCAT(<span class="string">&quot;FUNC_&quot;</span>, VARGS(__VA_ARGS__))(__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从而实现如下变参宏</span></span><br><span class="line"><span class="built_in">FUNC</span>(prefix, name, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">FUNC</span>(prefix, name)</span><br></pre></td></tr></table></figure>

<h2 id="工厂宏"><a href="#工厂宏" class="headerlink" title="工厂宏"></a>工厂宏</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Any</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Any</span>() : _var_ptr(<span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="title">Any</span><span class="params">(<span class="type">const</span> T&amp; value)</span> : _var_ptr(new Type&lt;T&gt;(value)) &#123;</span>&#125;</span><br><span class="line">    <span class="built_in">Any</span>(<span class="type">const</span> Any&amp; other) : _var_ptr(other._var_ptr ? other._var_ptr-&gt;<span class="built_in">clone</span>() : <span class="literal">NULL</span>) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">Any</span>() &#123;</span><br><span class="line">        <span class="keyword">delete</span> _var_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    T* <span class="title">any_cast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _var_ptr ? &amp;<span class="keyword">static_cast</span>&lt;Type &lt;T&gt;*&gt;(_var_ptr)-&gt;_var : <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Typeless</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">Typeless</span>() &#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Typeless* <span class="title">clone</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/// @brief Type calss template to hold a specific type</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Type</span> : <span class="keyword">public</span> Typeless &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Type</span><span class="params">(<span class="type">const</span> T&amp; value)</span> : _var(value) &#123;</span>&#125;</span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> Typeless* <span class="title">clone</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Type</span>(_var);</span><br><span class="line">        &#125;</span><br><span class="line">        T _var;             <span class="comment">///&lt; The real variable of a specific type</span></span><br><span class="line">    &#125;;</span><br><span class="line">    Typeless* _var_ptr;     <span class="comment">///&lt; Typeless variable pointer</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ConcreteFactory</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">Any</span> <span class="params">(* FactoryIntf)</span><span class="params">()</span></span>;  <span class="comment">/// a Function Pointer </span></span><br><span class="line"></span><br><span class="line">    FactoryIntf get_instance;      <span class="comment">///&lt; Function pointer to get instance</span></span><br><span class="line">    FactoryIntf get_singleton;     <span class="comment">///&lt; Function pointer to get singleton</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::map&lt;std::string, ConcreteFactory&gt; FactoryMap;</span><br><span class="line"><span class="keyword">typedef</span> std::map&lt;std::string, FactoryMap&gt; BaseClassMap;</span><br><span class="line"></span><br><span class="line"><span class="function">BaseClassMap&amp; <span class="title">g_factory_map</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> BaseClassMap base_class_map;    </span><br><span class="line">    <span class="keyword">return</span> base_class_map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_FACTORY(base_class) \</span></span><br><span class="line"><span class="meta">    class base_class ### Factory &#123; \</span></span><br><span class="line"><span class="meta">    public: \</span></span><br><span class="line"><span class="meta">        static base_class *get_instance(const ::std::string &amp;name) &#123; \</span></span><br><span class="line"><span class="meta">            FactoryMap &amp;map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            FactoryMap::iterator iter = map.find(name); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (iter == map.end()) &#123; \</span></span><br><span class="line"><span class="meta">                return NULL; \</span></span><br><span class="line"><span class="meta">            &#125; \</span></span><br><span class="line"><span class="meta">            Any object = iter-&gt;second.get_instance(); \</span></span><br><span class="line"><span class="meta">            return *(object.any_cast<span class="string">&lt;base_class*&gt;</span>()); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">        static base_class* get_singleton(const ::std::string&amp; name) &#123; \</span></span><br><span class="line"><span class="meta">            FactoryMap&amp; map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            FactoryMap::iterator iter = map.find(name); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (iter == map.end()) &#123; \</span></span><br><span class="line"><span class="meta">                return NULL; \</span></span><br><span class="line"><span class="meta">            &#125;\</span></span><br><span class="line"><span class="meta">            Any object = iter-&gt;second.get_singleton(); \</span></span><br><span class="line"><span class="meta">            return *(object.any_cast<span class="string">&lt;base_class*&gt;</span>()); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">        static const ::std::string get_uniq_instance_name() &#123; \</span></span><br><span class="line"><span class="meta">            FactoryMap &amp;map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (map.empty() || map.size() != 1) &#123; \</span></span><br><span class="line"><span class="meta">                return <span class="string">&quot;&quot;</span>; \</span></span><br><span class="line"><span class="meta">            &#125; \</span></span><br><span class="line"><span class="meta">            return map.begin()-&gt;first; \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">        static base_class *get_uniq_instance() &#123; \</span></span><br><span class="line"><span class="meta">            FactoryMap &amp;map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (map.empty() || map.size() != 1) &#123; \</span></span><br><span class="line"><span class="meta">                return NULL; \</span></span><br><span class="line"><span class="meta">            &#125; \</span></span><br><span class="line"><span class="meta">            Any object = map.begin()-&gt;second.get_instance(); \</span></span><br><span class="line"><span class="meta">            return *(object.any_cast<span class="string">&lt;base_class*&gt;</span>()); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">        static bool is_valid(const ::std::string &amp;name) &#123; \</span></span><br><span class="line"><span class="meta">            FactoryMap &amp;map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            return map.find(name) != map.end(); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">        static std::vector<span class="string">&lt;std::string&gt;</span> list_class() &#123;\</span></span><br><span class="line"><span class="meta">            std::vector<span class="string">&lt;std::string&gt;</span> ret; \</span></span><br><span class="line"><span class="meta">            auto &amp;m = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">            for (auto&amp; iter : m) &#123; \</span></span><br><span class="line"><span class="meta">              ret.emplace_back(iter.first);\</span></span><br><span class="line"><span class="meta">            &#125;\</span></span><br><span class="line"><span class="meta">            return ret;\</span></span><br><span class="line"><span class="meta">        &#125;\</span></span><br><span class="line"><span class="meta">    &#125;; \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_CLASS(base_class, sub_class) \</span></span><br><span class="line"><span class="meta">    namespace &#123; \</span></span><br><span class="line"><span class="meta">    Any sub_class##get_instance() &#123; \</span></span><br><span class="line"><span class="meta">        return Any(new sub_class()); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">    Any sub_class##get_singleton() &#123; \</span></span><br><span class="line"><span class="meta">        return Any(Singleton<span class="string">&lt;sub_class&gt;</span>::get()); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">    __attribute__((constructor)) void register_factory_##sub_class() &#123; \</span></span><br><span class="line"><span class="meta">        FactoryMap &amp;map = g_factory_map()[#base_class]; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (map.find(#sub_class) == map.end()) &#123; \</span></span><br><span class="line"><span class="meta">            ConcreteFactory factory = &#123;&amp;sub_class##get_instance, \</span></span><br><span class="line"><span class="meta">                                                 &amp;sub_class##get_singleton&#125;; \</span></span><br><span class="line"><span class="meta">            map[#sub_class] = factory; \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">char</span> <span class="params">(*func)</span><span class="params">(<span class="type">int</span>)</span></span>; <span class="comment">//函数指针</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jnjyan.github.io/b5f81b27516a/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E9%BB%91%E7%99%BD.jpg">
      <meta itemprop="name" content="JNJYan">
      <meta itemprop="description" content="以梦为马，越骑越傻">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Black Eye Galaxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/b5f81b27516a/" class="post-title-link" itemprop="url">tf serving源码阅读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-21 13:58:06" itemprop="dateCreated datePublished" datetime="2021-03-21T13:58:06+00:00">2021-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 08:59:08" itemprop="dateModified" datetime="2023-06-18T08:59:08+00:00">2023-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
                </span>
            </span>

          
            <span id="/b5f81b27516a/" class="post-meta-item leancloud_visitors" data-flag-title="tf serving源码阅读" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/b5f81b27516a/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/b5f81b27516a/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TF-Serving简介"><a href="#TF-Serving简介" class="headerlink" title="TF-Serving简介"></a>TF-Serving简介</h2><p>TensorFlow Serving是一个用于在生产环境中部署机器学习模型的应用系统，原生集成了TensorFlow模型，也可以扩展以应用其他类型的模型和数据。</p>
<h2 id="TF-Serving架构"><a href="#TF-Serving架构" class="headerlink" title="TF-Serving架构"></a>TF-Serving架构</h2><p><img src="https://www.tensorflow.org/tfx/serving/images/serving_architecture.svg?hl=zh-cn" alt="tf serving 架构"></p>
<ul>
<li>Servables</li>
<li>Loaders</li>
<li>Sources</li>
<li>Managers</li>
<li>Core</li>
</ul>
<h3 id="Servable"><a href="#Servable" class="headerlink" title="Servable"></a>Servable</h3><p>Servable是TF-Serving核心的对模型的抽象，Servable的大小和粒度都很灵活，任何能提供算法或数据查询的实体都可以抽象为Servable，服务可以是任何类型和接口。Servable不负责管理自己的生命周期，而是交由Manager管理。</p>
<p>典型的Servables包括：</p>
<ul>
<li>TesnorFlow SavedModelBundle</li>
<li>Embeddings查找表或词查找表</li>
</ul>
<h4 id="Servable相关的数据结构"><a href="#Servable相关的数据结构" class="headerlink" title="Servable相关的数据结构"></a>Servable相关的数据结构</h4><h5 id="tensorflow-serving-ServableId"><a href="#tensorflow-serving-ServableId" class="headerlink" title="tensorflow.serving.ServableId"></a>tensorflow.serving.ServableId</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ServableId</span>&#123;</span><br><span class="line">    string name;</span><br><span class="line">    int64 version;</span><br><span class="line">    <span class="function">string <span class="title">DebugString</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="tensorflow-serving-ServableData"><a href="#tensorflow-serving-ServableData" class="headerlink" title="tensorflow.serving.ServableData"></a>tensorflow.serving.ServableData</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServableData</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ServableData</span>(<span class="type">const</span> ServableId&amp;, T data);</span><br><span class="line">    <span class="function">T&amp; <span class="title">DataorDie</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">ConsumeDataorDie</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">ServableData</span>()=<span class="keyword">delete</span>;</span><br><span class="line">    <span class="type">const</span> ServableId id_;</span><br><span class="line">    <span class="type">const</span> Status status_;</span><br><span class="line">    T data_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="tensorflow-serving-ServableHandle"><a href="#tensorflow-serving-ServableHandle" class="headerlink" title="tensorflow.serving.ServableHandle"></a>tensorflow.serving.ServableHandle</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UntypedServableHandle</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> ServableId&amp; <span class="title">id</span><span class="params">()</span><span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> AnyPtr <span class="title">servable</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServableHandle</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">const</span> ServableId&amp; <span class="title">id</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> untyped_handle_-&gt;<span class="built_in">id</span>();&#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="type">const</span> &#123;<span class="keyword">return</span> *<span class="built_in">get</span>();&#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> &#123;<span class="keyword">return</span> <span class="built_in">get</span>();&#125;</span><br><span class="line">    <span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> servalbe_;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Manager</span>;</span><br><span class="line">    std::unique_ptr&lt;UntypedServableHandle&gt; Untyped_handle_;</span><br><span class="line">    T* servable_ = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SharedPtrHandle</span>: <span class="keyword">public</span> UntypedServableHandle&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~<span class="built_in">SharedPtrHandle</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">SharedPtrHandle</span><span class="params">(<span class="type">const</span> ServableId&amp; id, std::shared_ptr&lt;Loader&gt; loader)</span></span></span><br><span class="line"><span class="function">        : id_(id), loader_(std::move(loader)) &#123;</span>&#125;</span><br><span class="line">    <span class="function">AnyPtr <span class="title">servable</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> loader_-&gt;<span class="built_in">servable</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">const</span> ServableId&amp; <span class="title">id</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> id_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">const</span> ServableId id_;</span><br><span class="line">    std::shared_ptr&lt;Loader&gt; loader_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="tensorflow-serving-ServableState"><a href="#tensorflow-serving-ServableState" class="headerlink" title="tensorflow.serving.ServableState"></a>tensorflow.serving.ServableState</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ServableState</span>&#123;</span><br><span class="line">    ServableId id;</span><br><span class="line">    <span class="keyword">enum class</span> <span class="title class_">ManagerState</span> : <span class="type">int</span> &#123;</span><br><span class="line">        kStart, kLoading, kAvailable, kUnloading, kEnd,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="type">static</span> string <span class="title">ManagerStateString</span><span class="params">(ManagerState state)</span></span>&#123;...&#125;</span><br><span class="line">    MangerState manager_state;</span><br><span class="line">    Status health;</span><br><span class="line">    <span class="function">string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span> </span>&#123;...&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Loader"><a href="#Loader" class="headerlink" title="Loader"></a>Loader</h3><p>Loader对Servable的生命周期进行控制，包括load&#x2F;unload接口、资源预估接口等，加载后的Servable也存在Loader里面。Loader也用于扩展算法和数据后端（Tensorflow是其中一种）。当我们要添加一个新的backends时（如Pytorch等），需要为其实现一个新的Loader，以用于加载、卸载模型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//表示一个从storage加载的一个SavedModel</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SavedModelBundleInterface</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">SavedModelBundleInterface</span>();</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Session* <span class="title">GetSession</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> protobuf::Map&lt;string, SignatureDef&gt;&amp; <span class="title">GetSignatures</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SavedModelBundle</span>: <span class="keyword">public</span> SavedModelBundleInterface&#123;</span><br><span class="line">    ~<span class="built_in">SavedModelBundle</span>();</span><br><span class="line">    <span class="built_in">SavedModelBundle</span>();</span><br><span class="line">    <span class="function">Session* <span class="title">GetSession</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> session.<span class="built_in">get</span>();&#125;</span><br><span class="line">    <span class="function">protobuf::Map&lt;string, SignatureDef&gt;&amp; <span class="title">GetSignatures</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> meta_graph_def.<span class="built_in">signature_der</span>();&#125;</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;Session&gt; session;</span><br><span class="line">    MetaGraphDef meta_graph_def;</span><br><span class="line">    std::unique_ptr&lt;GraphDebugInfo&gt; debug_info;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="LoaderHarness"><a href="#LoaderHarness" class="headerlink" title="LoaderHarness"></a>LoaderHarness</h4><p>LoaderHarness是对Loader的封装，LoaderHarness负提供Loader的状态跟踪，ServingMap和ManagedMap里面保存的都是LoaderHarness对象，只有通过LoaderHarness才能访问Loader的接口。</p>
<h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><p>Source是对Servable的来源的抽象，Source监控外部资源，发现新的模型版本，并通知Target。Source为其提供的Servable的每个可用版本都提供一个Loader实例。</p>
<p>Source可以是：</p>
<ul>
<li>文件系统，本地或者HDFS</li>
<li>RPC</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Source</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Source</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">using</span> AspiredVersionsCallback = std::function&lt;<span class="built_in">void</span>(</span><br><span class="line">      <span class="type">const</span> StringPiece servable_name, std::vector&lt;ServableData&lt;T&gt;&gt; versions)&gt;;</span><br><span class="line">    <span class="comment">// 提供要使用的AspiredVersionCallback</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetAspiredVersionsCallback</span><span class="params">(AspiredVersionsCallback callback)</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StaticStoragePathSource</span> : <span class="keyword">public</span> Source&lt;StoragePath&gt;&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Status <span class="title">Create</span><span class="params">(<span class="type">const</span> StaticStoragePathSourceConfig&amp; config,   std::unique_ptr&lt;StaticStoragePathSource&gt;* result)</span></span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> raw_result = <span class="keyword">new</span> StaticStoragePathSource;</span><br><span class="line">        raw_result-&gt;config_ = config;</span><br><span class="line">        result-&gt;<span class="built_in">reset</span>(raw_result);</span><br><span class="line">        <span class="keyword">return</span> Status::<span class="built_in">Ok</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">StaticStoragePathSource</span>() <span class="keyword">override</span> = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetAspiredVersionsCallback</span><span class="params">(AspiredVersionsCallback callback)</span></span>&#123;</span><br><span class="line">        <span class="type">const</span> ServableId id = &#123;config_.<span class="built_in">servable_name</span>(), config_.<span class="built_in">version_num</span>()&#125;;</span><br><span class="line">        <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;Aspiring servable&quot;</span> &lt;&lt; id;</span><br><span class="line">        <span class="built_in">callback</span>(configt_.<span class="built_in">servable_name</span>(), &#123;<span class="built_in">CreateServableData</span>(id, confg_.<span class="built_in">version_path</span>())&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">StaticStoragePathSource</span>() = <span class="keyword">default</span>;</span><br><span class="line">    StaticStoragePathSourceConfig config_;</span><br><span class="line">    <span class="built_in">TF_DISALLOW_COPY_AND_ASSIGN</span>(StaticStoragePathSource);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileSystemStoragePathSource</span> : <span class="keyword">public</span> Source&lt;StoragePath&gt;&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Status <span class="title">Create</span><span class="params">(<span class="type">const</span> FileSystemStoragePathSourceConfig&amp; config, std::unique_ptr&lt;FileSystemStoragePathSource&gt;* result)</span></span>;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">FileSystemStoragePathSource</span>() <span class="keyword">override</span>;</span><br><span class="line">    <span class="function">Status <span class="title">UpdateConfig</span><span class="params">(<span class="type">const</span> FileSystemStoragePathSourceConfig&amp; config)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetAspiredVersionsCallback</span><span class="params">(AspiredVersionCallback callback)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">FileSystemStoragePathSource <span class="title">config</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="function">mutex_lock <span class="title">l</span><span class="params">(mu_)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> config_;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">internal</span>::FileSystemStoragePathSourceTestAccess;</span><br><span class="line">    <span class="built_in">FileSystemStoragePathSource</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Status <span class="title">PollFileSystemAndInvokeCallback</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Status <span class="title">UnaspireServables</span><span class="params">(<span class="type">const</span> std::set&lt;string&gt;&amp; servable_name)</span> <span class="title">TF_EXCLUSIVE_LOCKS_REQUIRED</span><span class="params">(mu_)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">CallAspiredVersionsCallback</span><span class="params">(Args&amp;&amp;... args)</span></span>&#123;</span><br><span class="line">        ...;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetAspiredVersionsCallbackNotifier</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; fn)</span> </span>&#123;</span><br><span class="line">    <span class="function">mutex_lock <span class="title">l</span><span class="params">(mu_)</span></span>;</span><br><span class="line">    aspired_versions_callback_notifier_ = fn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutable</span> mutex mu_;</span><br><span class="line">    <span class="function">FileSystemStoragePathSourceConfig config <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line">    <span class="function">AspiredVersionsCallback aspired_versions_callback_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line">    <span class="function">std::function&lt;<span class="title">void</span><span class="params">()</span>&gt; aspired_versions_callback_notifier_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line">    <span class="keyword">using</span> ThreadType = absl::variant&lt;absl::monostate, PeriodicFunction, std::unique_ptr&lt;Thread&gt;&gt;;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;ThreadType&gt; fs_polling_thread_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line">    <span class="built_in">TF_DISALLOW_COPY_AND_ASSIGN</span>(FileSystemStoragePathSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h4><p>Adapter是为了Source转成Loader而引入的抽象，这样server core的实现和具体的平台解耦，server core只需要调用LoaderHarness中的方法管理Servable（访问、加载、卸载等）。</p>
<h4 id="SourceRouter"><a href="#SourceRouter" class="headerlink" title="SourceRouter"></a>SourceRouter</h4><p>Adapter是平台相关的，每个平台一个Adapter，这里的平台指的是TF、Pytorch等。而Source是与Servable相关的，这样在Adapter和Source之间存在一对多的关系，Router负责维护这些对应关系。（这里似乎有些问题，需要仔细看下）</p>
<h3 id="ServerCore"><a href="#ServerCore" class="headerlink" title="ServerCore"></a>ServerCore</h3><p>服务系统的创建和维护，建立HTTP REST Server、GRPC Server和模型管理部分(AspiredVersionManger)之间的关系。</p>
<h3 id="AspiredVersionManager"><a href="#AspiredVersionManager" class="headerlink" title="AspiredVersionManager"></a>AspiredVersionManager</h3><p>模型管理的上层控制部分，负责执行Source发出的模型管理指令，一部分通过回调的方式由Source调用，一部分由独立线程执行。</p>
<h3 id="BasicManager"><a href="#BasicManager" class="headerlink" title="BasicManager"></a>BasicManager</h3><p>负责Servable的管理，包括加载、卸载、状态查询、资源跟踪，对外提供如下接口：</p>
<ol>
<li>ManageServable</li>
<li>LoadServable</li>
<li>UnloadServable</li>
<li>StopManagerServable</li>
</ol>
<p>提供接口查询servableHandle(GetUntypeServableHandle)，也就是加载好的模型，供http rest或grpc server调用进行推理。</p>
<p>所有受管理的servable都放在ManagedMap里，已经正常加载的servable同时也放在ServingMap进行管理，提供查询接口。</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h3><p>Target是和Source对应的抽象概念，AspiredVersionManager、Router都是Target。</p>
<h2 id="模型加载"><a href="#模型加载" class="headerlink" title="模型加载"></a>模型加载</h2><p><code>tensorflow_serving/model_servers/BUILD</code>中配置，可知，<code>tensorflow_model_server</code>的入口位于<code>tensorflow_serving/model_servers/main.cc</code></p>
<h3 id="大致流程"><a href="#大致流程" class="headerlink" title="大致流程"></a>大致流程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span>&#123;</span><br><span class="line">    Options option;</span><br><span class="line">    vector&lt;Flag&gt; flag_list;</span><br><span class="line">    <span class="comment">// cmd_line可以指定单个模型，多个模型需要配置config_file</span></span><br><span class="line">    usage = Flags::<span class="built_in">Usage</span>(argv[<span class="number">0</span>], flag_list);</span><br><span class="line">    <span class="comment">// Usage 使用命令行cmdline返回用法消息，并返回标志flag_list中的用法文本字符串。</span></span><br><span class="line">    Flags::<span class="built_in">Parse</span>(&amp;argc, argv, flag_list);</span><br><span class="line">    <span class="comment">// Parser 解析cmdline输入参数</span></span><br><span class="line">    port::<span class="built_in">InitMain</span>(argv[<span class="number">0</span>], &amp;argc, &amp;argv);</span><br><span class="line">    <span class="comment">// InitMain 实现为空，我瞎了？？？？</span></span><br><span class="line">    Server server;</span><br><span class="line">    status = server.<span class="built_in">BuildAndStart</span>(options);</span><br><span class="line">    server.<span class="built_in">WaitForTermination</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">BuildAndStart</span>(options)&#123;</span><br><span class="line">    <span class="built_in">SOME_CHECK_AND_PROCESS</span>(options);</span><br><span class="line">    ServerCore::<span class="built_in">Create</span>(<span class="built_in">move</span>(options), &amp;server_core_);</span><br><span class="line">    ::grpc::ServerBuilder builder;</span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>();</span><br><span class="line">    builder.<span class="built_in">RegeisterService</span>(xxx);</span><br><span class="line">    <span class="comment">//注册服务，model_service/prediction_service/profiler_service</span></span><br><span class="line">    grpc_server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    <span class="comment">// 启动grpc服务 </span></span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Status <span class="title">ServerCore::Create</span><span class="params">(Options options, ServerCore* servercore)</span></span>&#123;</span><br><span class="line">    options.servable_state_monitor_creator;</span><br><span class="line">    ServerRequestLogger::<span class="built_in">Create</span>(<span class="literal">nullptr</span>, options.server_request_logger);</span><br><span class="line">    aspired_version_policy = <span class="built_in">move</span>(options.aspired_version_policy);</span><br><span class="line">    server_core.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">ServerCore</span>(<span class="built_in">move</span>(options)));</span><br><span class="line">    (*server_core)-&gt;<span class="built_in">Initialize</span>(std::<span class="built_in">move</span>(aspired_version_policy));</span><br><span class="line">    <span class="keyword">return</span> (*server_core)-&gt;<span class="built_in">ReloadConfig</span>(model_server_config);</span><br><span class="line">    <span class="comment">// ReloadConfig 加载模型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Initialize</span>()&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">ServerCore::ReloadConfig</span><span class="params">(ModelServerConfig&amp; new_config)</span></span>&#123;</span><br><span class="line">    <span class="function">mutex_lock <span class="title">l</span><span class="params">(config_mu)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jnjyan.github.io/89c60482bada/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E9%BB%91%E7%99%BD.jpg">
      <meta itemprop="name" content="JNJYan">
      <meta itemprop="description" content="以梦为马，越骑越傻">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Black Eye Galaxy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/89c60482bada/" class="post-title-link" itemprop="url">Trie树</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-21 13:05:30" itemprop="dateCreated datePublished" datetime="2021-03-21T13:05:30+00:00">2021-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-18 08:59:08" itemprop="dateModified" datetime="2023-06-18T08:59:08+00:00">2023-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
                </span>
            </span>

          
            <span id="/89c60482bada/" class="post-meta-item leancloud_visitors" data-flag-title="Trie树" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/89c60482bada/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/89c60482bada/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!--
 * @Author: JNJYan
 * @LastEditors: JNJYan
 * @Email: jjy20140825@gmail.com
 * @Date: 2021-03-21 11:08:03
 * @LastEditTime: 2021-03-21 13:28:38
 * @Description: Modify here please
 * @FilePath: /blog/source/_posts/2021/03/Trie树.md
-->

<h2 id="Trie树的定义"><a href="#Trie树的定义" class="headerlink" title="Trie树的定义"></a>Trie树的定义</h2><p>Trie树，又被称为字典树、单词查找树，是一种哈希树变种。常用于统计、排序和保存大量的字符串，如搜索引擎系统中的文本词频统计、拼写的智能补全、字符串排序、最长公共前缀等。优点在于，利用字符串的公共前缀减少查询时间，查找效率比哈希树高。</p>
<h2 id="Trie树的实现"><a href="#Trie树的实现" class="headerlink" title="Trie树的实现"></a>Trie树的实现</h2><h3 id="Trie树结构"><a href="#Trie树结构" class="headerlink" title="Trie树结构"></a>Trie树结构</h3><p>对于Trie树的每一个节点，应当有一个标志位表示从根节点到当前节点的字符串是否存在，每个节点应当有26个儿子节点（与字符数量相同）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TrieNode</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">bool</span> isEnd;</span><br><span class="line">    TrieNode* next[<span class="number">26</span>];</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">TrieNode</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string str)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">search</span><span class="params">(string str)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">startWith</span><span class="params">(string prefix)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Init"><a href="#Init" class="headerlink" title="Init"></a>Init</h3><p>初始化一个Trie树，树的根节点应为空。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TrieNode</span><span class="params">()</span></span>&#123;</span><br><span class="line">    isEnd = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">memset</span>(next, <span class="number">0</span>, <span class="built_in">sizeof</span>(next));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string str)</span></span>&#123;</span><br><span class="line">    Trie* node = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">char</span> ch: str)&#123;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;next[ch-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>)</span><br><span class="line">            node-&gt;next[ch-<span class="string">&#x27;a&#x27;</span>] = <span class="keyword">new</span> <span class="built_in">Trie</span>();</span><br><span class="line">        node = node-&gt;next[ch-<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    node-&gt;isEnd = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">search</span><span class="params">(string str)</span></span>&#123;</span><br><span class="line">    Trie* node = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">char</span> ch: str)&#123;</span><br><span class="line">        node = node-&gt;next[ch-<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;isEnd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StartWith"><a href="#StartWith" class="headerlink" title="StartWith"></a>StartWith</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">StartWith</span><span class="params">(string str)</span></span>&#123;</span><br><span class="line">    Trie* node = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">char</span> ch: str)&#123;</span><br><span class="line">        node = node-&gt;next[ch-<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="哈希树"><a href="#哈希树" class="headerlink" title="哈希树"></a>哈希树</h2><p>哈希树（HashTree）是一种持久性数据结构，用于实现集合和映射。通过质数分辨法建立哈希树，从第二层开始，每层的节点数为连续质数(2,3,5,7…)，从左至右分别为对于该质数的余数。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="JNJYan"
      src="/images/%E9%BB%91%E7%99%BD.jpg">
  <p class="site-author-name" itemprop="name">JNJYan</p>
  <div class="site-description" itemprop="description">以梦为马，越骑越傻</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jnjyan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jnjyan" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jjy20140825@gmail.com" title="E-Mail → mailto:jjy20140825@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JNJYan</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '67N9uXqPnCYl5B83g0FFVgob-gzGzoHsz',
      appKey     : 'b6Uh6OmG6qcnmzhznNKskpnM',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
