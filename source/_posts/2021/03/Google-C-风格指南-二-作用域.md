---
title: Google C++风格指南(二)——作用域
date: 2021-03-24 20:18:03
tags: C++编码规范
categories:
- C++
---

# 命名空间
C++中的全局函数和全局变量的作用域是整个项目，为了限制其作用域，一种做法是使用`static`关键字修饰，另一种是使用命名空间。

在不需要外部访问的情况下，C++标准提倡使用匿名命名空间，禁止使用`using`引入命名空间，禁止使用内联命名空间。


```c++
namespace X{
    inline namespace Y{
        void foo();
    }
}

// 别名
namespace baz = ::foo::bar::baz;
```

在内联命名空间中，`X::Y::foo()`与`X::foo()`等价，其目的主要是用来兼容跨版本API。

命名空间使用策略：
- 遵循命名空间命名规范
- 命名空间结束时，使用注释
- 命名空间应当在头文件、gflag声明与定义、其他空间的类前置声明之后
- 禁止在`std`内声明任何东西，属于未定义行为，导致不可移植
- 禁止在头文件中使用命名空间别名，除非限制在内部命名空间中使用
- 禁止使用`using`引入命名空间
- 禁止使用内联命名空间

# 匿名命名空间与静态变量
在`cxx`中定义不需要被外部引用的符号时，可以放在匿名命名空间或声明为`static`，但不要在头文件中这样做。

# 非成员函数、静态成员函数、全局函数
使用静态成员或命名空间内的非成员函数，不要使用裸的全局函数，不要用类的静态方法模拟命名空间效果，类的静态方法应当与类的实例或静态数据密切相关。

非成员函数置于命名空间避免污染全局作用域。

# 局部变量
将函数变量尽可能放在最小作用域内，在变量声明时进行初始化。

除非变量是一个对象，每次进入作用域都需要调用构造函数，退出作用域调用析构函数。

# 静态和全局变量
静态生存周期的对象，包括全局变量、静态变量、静态类成员、函数静态变量，必须是原生数据类型(POD, Plain Old Data)。

在多编译单元中，静态变量的构造、析构和初始化顺序在C++中只有部分是明确的，甚至随着构建发生变化，导致难以发现的bug，禁止使用类的静态存储周期变量。

在同一编译单元中顺序是明确的，静态初始化优于动态初始化、初始化顺序按照声明顺序进行，逆序销毁，不同编译单元内，属于未明确行为。

多线程时，静态生存周期不要使用非POD的对象以及STL容器。